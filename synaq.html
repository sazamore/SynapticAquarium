<!DOCTYPE html>
<head>
<title>MEANWHILE, AT WEBPAGE...</title>
<script src="https://code.jquery.com/jquery-2.1.0.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/dygraph/1.0.1/dygraph-combined.js"></script>
<script type="text/javascript">
"use strict";
window.requestAnimationFrame = 
    window.requestAnimationFrame || 
    window.mozRequestAnimationFrame ||  
    window.webkitRequestAnimationFrame || 
    window.msRequestAnimationFrame;

window.URL = window.URL ||
             window.webkitURL

var model_id = null;
$(document).ready(function(e) {
    var $graph = $("#graph");
    var dygraph;
    var data = [];
    var curNeurons = 0; // Number of neurons currently grphed
    var labels = ['V'];
    var marching = false;
    $("#create").on("click", function(e) {
        var paramMap = {"model_id": model_id};
        $("#params input").each(function(key, elem) {
            var val = $(elem).val();
            if (val !== "") {
                paramMap[$(elem).attr('id')] = val;
            }
        });
        console.log(paramMap);
        $.get("/synaq/new/", paramMap, function(name) {
            $('#neurons').append('<tr><td>' + name + '</td></tr>');
        })
        labels.push(name);
    });
    $("#step").on('click', function recurse (e) {
        $.get("/synaq/step/", { // Get some data
                "steps": (dygraph === undefined ? 1000 : 5),
                "model_id": model_id
             }, function(V) {
            if (dygraph === undefined) {
                data = V;
                console.log("Dygraphing", data, "into", $graph[0], Dygraph);
                dygraph = new Dygraph(document.getElementById('graph'), 
                    data, {
                    "valueRange": [-50, 150],
                    "width": "100%",
                    "xlabel": "Time(ms)",
                    "ylabel": "Potential(mV)",
                    "labels": labels
                });
            } else {
                for (var i = 0; i < V.length; i++) {
                    data.push(V[i]);
                    data.shift();
                }
                dygraph.updateOptions({"data": data});
            }
            if (marching) {
                recurse();
            }
        }, 'json');
    });
    $("#march").on('click', function(e) {
        marching = !marching;
        if (marching) {
            $('#step').click();
        }
    });
    $("#reset").on('click', function(e) {
        $.get("/synaq/reset", function(response) {
            $("#graph").empty();
            $("#neurons").empty();
            dygraph = undefined;
            labels = ['T'];
            data = [];
            model_id = response;
            $('#model_id').text(model_id);
            console.log("Got new ID", response);
        }, 'text');
    });
});
$(document)
</script>
</head>
<style type="text/css">
body {
    background-color: #333;
    color: red;
    font-family: monospace;
}
#graph {
    width: 50%;
    height: 300px;
}
input {
    background-color: #333;
    border: 2px solid red;
    font-family: monospace;
    color: red;
}
button {
    background-color: #333;
    border: 2px solid red;
    font-family: monospace;
    color: red;
}
</style>
<body>
<div id="graph"></div>
<div id="params">
    <table>
        <tr>
            <td>dT</td><td><input id="dT" /></td>
        </tr>
        <tr>
            <td>steps</td><td><input id="steps" /></td>
        </tr>
        <tr>
            <td>V_zero</td><td><input id="V_zero" /></td>
        </tr>
        <tr>
            <td>Cm</td><td><input id="Cm" /></td>
        </tr>
        <tr>
            <td>gbar_Na</td><td><input id="gbar_Na" /></td>
        </tr>
        <tr>
            <td>gbar_K</td><td><input id="gbar_K" /></td>
        </tr>
        <tr>
            <td>gbar_l</td><td><input id="gbar_l" /></td>
        </tr>
        <tr>
            <td>E_Na</td><td><input id="E_Na" /></td>
        </tr>
        <tr>
            <td>E_K</td><td><input id="E_K" /></td>
        </tr>
        <tr>
            <td>E_l</td><td><input id="E_l" /></td>
        </tr>
        <tr>
            <td>I</td><td><input id="I" /></td>
        </tr>
    </table>
</div>
<button id="create">Add a Neuron!</button>
<button id="step">Step!</button>
<button id="march">March!</button>
<button id="reset">Reset!</button>
<table id="neurons">
</table>
<div id="model_id"></div>
</body>
</html>
